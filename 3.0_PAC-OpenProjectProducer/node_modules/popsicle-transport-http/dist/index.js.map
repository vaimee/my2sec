{"version":3,"file":"index.js","sourceRoot":"","sources":["../src/index.ts"],"names":[],"mappings":"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","sourcesContent":["import { URL } from \"url\";\nimport { request as httpRequest, IncomingMessage } from \"http\";\nimport { request as httpsRequest, RequestOptions } from \"https\";\nimport { BaseError } from \"make-error-cause\";\nimport {\n  connect as netConnect,\n  Socket,\n  AddressInfo,\n  NetConnectOpts,\n} from \"net\";\nimport {\n  connect as tlsConnect,\n  SecureContext,\n  TLSSocket,\n  ConnectionOptions as TlsConnectOpts,\n} from \"tls\";\nimport {\n  connect as http2Connect,\n  IncomingHttpHeaders,\n  constants as h2constants,\n  ClientHttp2Session,\n} from \"http2\";\nimport { pipeline, PassThrough, Writable, Readable } from \"stream\";\nimport { lookup as dnsLookup, LookupOptions } from \"dns\";\nimport {\n  Request,\n  Response,\n  CreateBody,\n  ResponseOptions,\n  HeadersInit,\n} from \"servie/dist/node\";\nimport { useRawBody } from \"servie/dist/common\";\n\n/**\n * Add HTTP signals to servie events.\n */\ndeclare module \"servie/dist/signal\" {\n  export interface SignalEvents {\n    error: [Error];\n  }\n}\n\n/**\n * Address information from the HTTP request.\n */\nexport interface Connection {\n  localPort: number;\n  localAddress: string;\n  remotePort: number;\n  remoteAddress: string;\n  encrypted: boolean;\n}\n\n/**\n * Extend response with URL.\n */\nexport interface HttpResponseOptions extends ResponseOptions {\n  url: string;\n  connection: Connection;\n  httpVersion: string;\n}\n\n/**\n * HTTP responses implement a node.js body.\n */\nexport class HttpResponse extends Response implements HttpResponseOptions {\n  url: string;\n  httpVersion: string;\n  connection: Connection;\n\n  constructor(body: CreateBody, options: HttpResponseOptions) {\n    super(body, options);\n    this.url = options.url;\n    this.connection = options.connection;\n    this.httpVersion = options.httpVersion;\n  }\n}\n\nexport class Http2Response extends HttpResponse {\n  // TODO: Add HTTP2 features.\n}\n\n/**\n * Abstract connection manager.\n */\nexport interface ConnectionManager<T> {\n  /**\n   * Request a connection and initialize in `onReady` once available.\n   */\n  ready(\n    key: string,\n    onReady: (connection: T | undefined) => T | Promise<T>\n  ): Promise<T>;\n  /**\n   * Create a connection within the `create` callback for tracking.\n   */\n  creating(key: string, create: () => Promise<T>): Promise<T>;\n  /**\n   * Claims an existing connection as \"in-use\".\n   */\n  used(key: string, connection: T): void;\n  /**\n   * Removes a connection from \"in-use\" using the connection key and connection.\n   * Return `true` when the connection has been deleted from the manager and the\n   * connection must be destroyed.\n   */\n  freed(key: string, connection: T): boolean;\n  /**\n   * Gets any connection (or `undefined` when none exist) using the connection key.\n   */\n  get(key: string): T | undefined;\n  /**\n   * Gets a free connection (or `undefined` if none are free) using the connection key.\n   */\n  free(key: string): T | undefined;\n  /**\n   * Deletes a connection from free and in-use using the connection key.\n   */\n  delete(key: string, connection: T): void;\n}\n\n/**\n * Set of connections for HTTP pooling.\n */\nexport class SocketSet<T> {\n  // Tracks number of sockets claimed before they're created.\n  creating = 0;\n  // Tracks free sockets.\n  free = new Set<T>();\n  // Tracks all available sockets.\n  sockets = new Set<T>();\n  // Tracks pending requests for a socket.\n  pending: Array<(connection: T | undefined) => void> = [];\n  // Get number of sockets available + creating.\n  size(): number {\n    return this.creating + this.sockets.size;\n  }\n  // Check if the pool is empty and can be cleaned up.\n  isEmpty(): boolean {\n    return this.size() === 0 && this.pending.length === 0;\n  }\n}\n\n/**\n * Get the value of an iterator.\n */\nfunction value<T>(iterator: Iterator<T, undefined>): T | undefined {\n  return iterator.next().value;\n}\n\n/**\n * Manage socket reuse.\n */\nexport class SocketConnectionManager<T extends Socket | TLSSocket>\n  implements ConnectionManager<T> {\n  pools = new Map<string, SocketSet<T>>();\n\n  constructor(\n    public maxFreeConnections = 256,\n    public maxConnections = Infinity\n  ) {}\n\n  /**\n   * Creates a connection when available.\n   */\n  async ready(\n    key: string,\n    onReady: (connection: T | undefined) => T | Promise<T>\n  ): Promise<T> {\n    const pool = this.pool(key);\n\n    // Add to \"pending\" queue when over max connections.\n    if (pool.size() >= this.maxConnections) {\n      return new Promise<T | undefined>((resolve) =>\n        pool.pending.push(resolve)\n      ).then(onReady);\n    }\n\n    return onReady(this.free(key));\n  }\n\n  async creating(key: string, onCreate: () => Promise<T>): Promise<T> {\n    const pool = this.pool(key);\n    try {\n      pool.creating++;\n      const socket = await onCreate();\n      return socket;\n    } finally {\n      pool.creating--;\n    }\n  }\n\n  pool(key: string): SocketSet<T> {\n    const pool = this.pools.get(key);\n    if (!pool) {\n      const pool = new SocketSet<T>();\n      this.pools.set(key, pool);\n      return pool;\n    }\n    return pool;\n  }\n\n  used(key: string, socket: T): void {\n    socket.ref();\n\n    const pool = this.pool(key);\n    pool.free.delete(socket);\n    pool.sockets.add(socket);\n  }\n\n  freed(key: string, socket: T): boolean {\n    const pool = this.pools.get(key);\n    if (!pool || !pool.sockets.has(socket)) return false;\n\n    // Immediately reuse for a pending connection.\n    const onReady = pool.pending.shift();\n    if (onReady) {\n      onReady(socket);\n      return false;\n    }\n\n    // Remove reference to freed sockets.\n    socket.unref();\n\n    // Save freed connections for reuse.\n    if (pool.free.size < this.maxFreeConnections) {\n      pool.free.add(socket);\n      return false;\n    }\n\n    this._delete(pool, key, socket);\n    return true;\n  }\n\n  private _delete(pool: SocketSet<T>, key: string, socket: T) {\n    pool.free.delete(socket);\n    pool.sockets.delete(socket);\n    if (pool.isEmpty()) this.pools.delete(key);\n  }\n\n  get(key: string): T | undefined {\n    const pool = this.pools.get(key);\n    if (pool) return value(pool.sockets.values());\n  }\n\n  free(key: string): T | undefined {\n    const pool = this.pools.get(key);\n    if (pool) return value(pool.free.values());\n  }\n\n  delete(key: string, socket: T): void {\n    const pool = this.pools.get(key);\n    if (!pool || !pool.sockets.has(socket)) return;\n\n    // Remove the socket from the pool before calling a new `onReady`.\n    this._delete(pool, key, socket);\n\n    // Create a new pending socket when an old socket is removed.\n    // If a socket was removed we MUST be below `maxConnections`.\n    // We also MUST have already used our `free` connections up otherwise we\n    // wouldn't have a pending callback.\n    const onReady = pool.pending.shift();\n    if (onReady) onReady(undefined);\n  }\n}\n\nexport class Http2ConnectionManager\n  implements ConnectionManager<ClientHttp2Session> {\n  sessions = new Map<string, ClientHttp2Session>();\n  refs = new WeakMap<ClientHttp2Session, number>();\n\n  async ready(\n    key: string,\n    onReady: (\n      session: ClientHttp2Session | undefined\n    ) => ClientHttp2Session | Promise<ClientHttp2Session>\n  ): Promise<ClientHttp2Session> {\n    return onReady(this.sessions.get(key));\n  }\n\n  async creating(\n    key: string,\n    create: () => Promise<ClientHttp2Session>\n  ): Promise<ClientHttp2Session> {\n    return create();\n  }\n\n  used(key: string, session: ClientHttp2Session): void {\n    const count = this.refs.get(session) || 0;\n    if (count === 0) session.ref();\n\n    this.refs.set(session, count + 1);\n    this.sessions.set(key, session);\n  }\n\n  freed(key: string, session: ClientHttp2Session): boolean {\n    const count = this.refs.get(session);\n    if (!count) return false;\n    if (count === 1) session.unref();\n    this.refs.set(session, count - 1);\n    return false;\n  }\n\n  get(key: string): ClientHttp2Session | undefined {\n    return this.sessions.get(key);\n  }\n\n  free(key: string): ClientHttp2Session | undefined {\n    return this.sessions.get(key);\n  }\n\n  delete(key: string, session: ClientHttp2Session): void {\n    if (this.sessions.get(key) === session) {\n      this.refs.delete(session);\n      this.sessions.delete(key);\n    }\n  }\n}\n\nexport const defaultNetConnect: CreateNetConnection = netConnect;\nexport const defaultTlsConnect: CreateTlsConnection = tlsConnect;\nexport const defaultHttp2Connect: CreateHttp2Connection = (\n  authority,\n  socket\n) => {\n  return http2Connect(authority, { createConnection: () => socket });\n};\n\nfunction pipelineRequest(\n  req: Request,\n  stream: Writable,\n  onError: (err: Error) => void\n): void {\n  let bytesTransferred = 0;\n  const onData = (chunk: Buffer) => {\n    req.signal.emit(\"requestBytes\", (bytesTransferred += chunk.length));\n  };\n\n  const requestStream = new PassThrough();\n  requestStream.on(\"data\", onData);\n  req.signal.emit(\"requestStarted\");\n\n  pipeline(requestStream, stream, (err) => {\n    requestStream.removeListener(\"data\", onData);\n\n    if (err) req.signal.emit(\"error\", err);\n    req.signal.emit(\"requestEnded\");\n  });\n\n  const body = useRawBody(req);\n\n  if (body instanceof ArrayBuffer) {\n    return requestStream.end(new Uint8Array(body));\n  }\n\n  if (Buffer.isBuffer(body) || typeof body === \"string\" || body === null) {\n    return requestStream.end(body);\n  }\n\n  pipeline(body, requestStream, (err) => {\n    if (err) return onError(err);\n  });\n}\n\nfunction pipelineResponse(req: Request, stream: Readable, onEnd: () => void) {\n  let bytesTransferred = 0;\n  const onData = (chunk: Buffer) => {\n    req.signal.emit(\"responseBytes\", (bytesTransferred += chunk.length));\n  };\n\n  const responseStream = new PassThrough();\n  stream.on(\"data\", onData);\n  req.signal.emit(\"responseStarted\");\n\n  return pipeline(stream, responseStream, (err) => {\n    stream.removeListener(\"data\", onData);\n\n    onEnd();\n\n    if (err) req.signal.emit(\"error\", err);\n    req.signal.emit(\"responseEnded\");\n  });\n}\n\n/**\n * Used as a cause for the connection error.\n */\nexport class CausedByEarlyCloseError extends Error {\n  constructor() {\n    super(\"Connection closed too early\");\n  }\n}\n\n/**\n * Used as a cause for the connection error.\n */\nexport class CausedByTimeoutError extends Error {\n  constructor() {\n    super(\"Connection timeout\");\n  }\n}\n\n/**\n * Expose connection errors.\n */\nexport class ConnectionError extends BaseError {\n  code = \"EUNAVAILABLE\";\n\n  constructor(public request: Request, message: string, cause: Error) {\n    super(message, cause);\n  }\n}\n\n/**\n * Execute HTTP request.\n */\nfunction execHttp1(\n  req: Request,\n  url: URL,\n  socket: Socket | TLSSocket,\n  config: TransportConfig\n): Promise<HttpResponse> {\n  return new Promise<HttpResponse>((resolve, reject) => {\n    const encrypted = url.protocol === \"https:\";\n    const request: typeof httpRequest = encrypted ? httpsRequest : httpRequest;\n\n    const arg: RequestOptions = {\n      protocol: url.protocol,\n      hostname: url.hostname,\n      port: url.port,\n      defaultPort: encrypted ? 443 : 80, // Specify to avoid `Host` header issues.\n      method: req.method,\n      path: url.pathname + url.search,\n      headers: req.headers.asObject(),\n      auth:\n        url.username || url.password\n          ? `${url.username}:${url.password}`\n          : undefined,\n      createConnection: () => socket,\n    };\n\n    const rawRequest = request(arg);\n\n    rawRequest.on(\"timeout\", () => {\n      rawRequest.destroy();\n\n      return reject(\n        new ConnectionError(\n          req,\n          `Connection timed out to ${url.host}`,\n          new CausedByTimeoutError()\n        )\n      );\n    });\n\n    // Timeout when no activity, pick minimum as request is using the entire socket.\n    rawRequest.setTimeout(\n      config.idleSocketTimeout > 0\n        ? Math.min(config.idleRequestTimeout, config.idleSocketTimeout)\n        : config.idleRequestTimeout\n    );\n\n    // Reuse HTTP connections where possible.\n    if (config.keepAlive > 0) {\n      rawRequest.shouldKeepAlive = true;\n      rawRequest.setHeader(\"Connection\", \"keep-alive\");\n    }\n\n    // Trigger unavailable error when node.js errors before response.\n    const onRequestError = (err: Error) => {\n      return reject(\n        new ConnectionError(req, `Unable to connect to ${url.host}`, err)\n      );\n    };\n\n    // Track the node.js response.\n    const onResponse = (rawResponse: IncomingMessage) => {\n      // Trailers are populated on \"end\".\n      let resolveTrailers: (headers: HeadersInit) => void;\n      const trailer = new Promise<HeadersInit>(\n        (resolve) => (resolveTrailers = resolve)\n      );\n\n      rawRequest.removeListener(\"response\", onResponse);\n      rawRequest.removeListener(\"error\", onRequestError);\n\n      const {\n        address: localAddress,\n        port: localPort,\n      } = (rawRequest.socket?.address() ?? {}) as AddressInfo;\n\n      const {\n        address: remoteAddress,\n        port: remotePort,\n      } = rawResponse.socket.address() as AddressInfo;\n\n      // Force `end` to be triggered so the response can still be piped.\n      // Reference: https://github.com/nodejs/node/issues/27981\n      const onAborted = () => {\n        rawResponse.push(null);\n      };\n\n      rawResponse.on(\"aborted\", onAborted);\n\n      const res = new HttpResponse(\n        pipelineResponse(req, rawResponse, () => {\n          req.signal.off(\"abort\", onAbort);\n          rawResponse.removeListener(\"aborted\", onAborted);\n\n          resolveTrailers(rawResponse.trailers);\n        }),\n        {\n          status: rawResponse.statusCode,\n          statusText: rawResponse.statusMessage,\n          url: req.url,\n          headers: rawResponse.headers,\n          omitDefaultHeaders: true,\n          trailer,\n          connection: {\n            localAddress,\n            localPort,\n            remoteAddress,\n            remotePort,\n            encrypted,\n          },\n          httpVersion: rawResponse.httpVersion,\n        }\n      );\n\n      return resolve(res);\n    };\n\n    const onAbort = () => {\n      rawRequest.destroy();\n    };\n\n    // Clean up lingering request listeners on close.\n    const onClose = () => {\n      req.signal.off(\"abort\", onAbort);\n      rawRequest.removeListener(\"error\", onRequestError);\n      rawRequest.removeListener(\"response\", onResponse);\n      rawRequest.removeListener(\"close\", onClose);\n    };\n\n    req.signal.on(\"abort\", onAbort);\n    rawRequest.once(\"error\", onRequestError);\n    rawRequest.once(\"response\", onResponse);\n    rawRequest.once(\"close\", onClose);\n\n    return pipelineRequest(req, rawRequest, reject);\n  });\n}\n\n/**\n * ALPN validation error.\n */\nexport class ALPNError extends Error {\n  code = \"EALPNPROTOCOL\";\n\n  constructor(public request: Request, message: string) {\n    super(message);\n  }\n}\n\n/**\n * Execute a HTTP2 connection.\n */\nfunction execHttp2(\n  key: string,\n  client: ClientHttp2Session,\n  req: Request,\n  url: URL,\n  config: TransportConfig\n): Promise<Http2Response> {\n  return new Promise<Http2Response>((resolve, reject) => {\n    // HTTP2 formatted headers.\n    const headers = Object.assign(\n      {\n        [h2constants.HTTP2_HEADER_METHOD]: req.method,\n        [h2constants.HTTP2_HEADER_AUTHORITY]: url.host,\n        [h2constants.HTTP2_HEADER_SCHEME]: url.protocol.slice(0, -1),\n        [h2constants.HTTP2_HEADER_PATH]: url.pathname + url.search,\n      },\n      req.headers.asObject()\n    );\n\n    const http2Stream = client.request(headers, { endStream: false });\n    let cause = new CausedByEarlyCloseError();\n\n    // Handle socket timeouts more gracefully.\n    const onSocketTimeout = () => {\n      cause = new CausedByTimeoutError();\n    };\n\n    // Timeout after no activity.\n    http2Stream.setTimeout(config.idleRequestTimeout, () => {\n      cause = new CausedByTimeoutError();\n      http2Stream.close(h2constants.NGHTTP2_CANCEL);\n    });\n\n    // Trigger unavailable error when node.js errors before response.\n    const onRequestError = (err: Error) => {\n      return reject(\n        new ConnectionError(req, `Unable to connect to ${url.host}`, err)\n      );\n    };\n\n    const onResponse = (headers: IncomingHttpHeaders) => {\n      const encrypted = (client.socket as TLSSocket).encrypted === true;\n      const {\n        localAddress = \"\",\n        localPort = 0,\n        remoteAddress = \"\",\n        remotePort = 0,\n      } = client.socket;\n\n      let resolveTrailers: (headers: HeadersInit) => void;\n      const trailer = new Promise<HeadersInit>(\n        (resolve) => (resolveTrailers = resolve)\n      );\n\n      const onTrailers = (headers: IncomingHttpHeaders) => {\n        resolveTrailers(headers);\n      };\n\n      http2Stream.once(\"trailers\", onTrailers);\n\n      const res = new Http2Response(\n        pipelineResponse(req, http2Stream, () => {\n          req.signal.off(\"abort\", onAbort);\n          http2Stream.removeListener(\"trailers\", onTrailers);\n\n          resolveTrailers({}); // Resolve in case \"trailers\" wasn't emitted.\n        }),\n        {\n          status: Number(headers[h2constants.HTTP2_HEADER_STATUS]),\n          statusText: \"\",\n          url: req.url,\n          httpVersion: \"2.0\",\n          headers,\n          omitDefaultHeaders: true,\n          trailer,\n          connection: {\n            localAddress,\n            localPort,\n            remoteAddress,\n            remotePort,\n            encrypted,\n          },\n        }\n      );\n\n      return resolve(res);\n    };\n\n    const onAbort = () => {\n      http2Stream.destroy();\n    };\n\n    // Release the HTTP2 connection claim when the stream ends.\n    const onClose = () => {\n      // Clean up all lingering event listeners on final close.\n      req.signal.off(\"abort\", onAbort);\n      http2Stream.removeListener(\"error\", onRequestError);\n      http2Stream.removeListener(\"response\", onResponse);\n      http2Stream.removeListener(\"close\", onClose);\n      client.socket?.removeListener(\"timeout\", onSocketTimeout);\n\n      const shouldDestroy = config.http2Sessions.freed(key, client);\n      if (shouldDestroy) client.destroy();\n\n      // Handle when the server closes the stream without responding.\n      return reject(\n        new ConnectionError(\n          req,\n          `Connection closed without response from ${url.host}`,\n          cause\n        )\n      );\n    };\n\n    req.signal.on(\"abort\", onAbort);\n    http2Stream.once(\"error\", onRequestError);\n    http2Stream.once(\"response\", onResponse);\n    http2Stream.once(\"close\", onClose);\n    client.socket.once(\"timeout\", onSocketTimeout);\n    config.http2Sessions.used(key, client);\n\n    return pipelineRequest(req, http2Stream, reject);\n  });\n}\n\n/**\n * Configure HTTP version negotiation.\n */\nexport enum NegotiateHttpVersion {\n  HTTP1_ONLY,\n  HTTP2_FOR_HTTPS,\n  HTTP2_ONLY,\n}\n\nexport type CreateNetConnection = (\n  options: NetConnectOpts\n) => Socket | Promise<Socket>;\nexport type CreateTlsConnection = (\n  options: TlsConnectOpts\n) => TLSSocket | Promise<TLSSocket>;\nexport type CreateHttp2Connection = (\n  authority: URL,\n  socket: Socket | TLSSocket\n) => ClientHttp2Session | Promise<ClientHttp2Session>;\n\nexport type LookupFunction = (\n  hostname: string,\n  options: LookupOptions,\n  callback: (err: Error | null, address: string, family: number) => void\n) => void;\n\n/**\n * Node.js HTTP request options.\n */\nexport interface TransportOptions {\n  keepAlive?: number;\n  idleSocketTimeout?: number;\n  idleRequestTimeout?: number;\n  servername?: string;\n  rejectUnauthorized?: boolean;\n  negotiateHttpVersion?: NegotiateHttpVersion;\n  ca?: string | Buffer | Array<string | Buffer>;\n  cert?: string | Buffer;\n  key?: string | Buffer;\n  secureContext?: SecureContext;\n  secureProtocol?: string;\n  secureOptions?: number;\n  tlsSockets?: ConnectionManager<TLSSocket>;\n  netSockets?: ConnectionManager<Socket>;\n  http2Sessions?: ConnectionManager<ClientHttp2Session>;\n  lookup?: LookupFunction;\n  createHttp2Connection?: CreateHttp2Connection;\n  createNetConnection?: CreateNetConnection;\n  createTlsConnection?: CreateTlsConnection;\n}\n\n/**\n * Custom abort error instance.\n */\nexport class AbortError extends Error {\n  code = \"EABORT\";\n\n  constructor(public request: Request, message: string) {\n    super(message);\n  }\n}\n\nconst DEFAULT_KEEP_ALIVE = 5_000; // 5 seconds.\nconst DEFAULT_IDLE_REQUEST_TIMEOUT = 30_000; // 30 seconds.\nconst DEFAULT_IDLE_SOCKET_TIMEOUT = 300_000; // 5 minutes.\n\n/**\n * Shared configuration options during request execution.\n */\ninterface TransportConfig {\n  keepAlive: number;\n  idleSocketTimeout: number;\n  idleRequestTimeout: number;\n  tlsSockets: ConnectionManager<TLSSocket>;\n  netSockets: ConnectionManager<Socket>;\n  http2Sessions: ConnectionManager<ClientHttp2Session>;\n}\n\nfunction optionsToConfig(options: TransportOptions): TransportConfig {\n  const {\n    keepAlive = DEFAULT_KEEP_ALIVE,\n    idleSocketTimeout = DEFAULT_IDLE_SOCKET_TIMEOUT,\n    idleRequestTimeout = DEFAULT_IDLE_REQUEST_TIMEOUT,\n    tlsSockets = new SocketConnectionManager<TLSSocket>(),\n    netSockets = new SocketConnectionManager<Socket>(),\n    http2Sessions = new Http2ConnectionManager(),\n  } = options;\n\n  return {\n    keepAlive,\n    idleSocketTimeout,\n    idleRequestTimeout,\n    tlsSockets,\n    netSockets,\n    http2Sessions,\n  };\n}\n\n/**\n * Forward request over HTTP1/1 or HTTP2, with TLS support.\n */\nexport function transport(\n  options: TransportOptions = {}\n): (req: Request, next: () => Promise<Response>) => Promise<Response> {\n  const config = optionsToConfig(options);\n  const { netSockets, tlsSockets, http2Sessions } = config;\n  const {\n    lookup = dnsLookup,\n    createNetConnection = defaultNetConnect,\n    createTlsConnection = defaultTlsConnect,\n    createHttp2Connection = defaultHttp2Connect,\n    negotiateHttpVersion = NegotiateHttpVersion.HTTP2_FOR_HTTPS,\n  } = options;\n\n  return async (req, next) => {\n    const url = new URL(req.url, \"http://localhost\");\n    const { hostname, protocol } = url;\n\n    if (req.signal.aborted) {\n      throw new AbortError(req, \"Request has been aborted\");\n    }\n\n    if (protocol === \"http:\") {\n      const port = Number(url.port) || 80;\n      const connectionKey = `${hostname}:${port}:${negotiateHttpVersion}`;\n\n      if (negotiateHttpVersion === NegotiateHttpVersion.HTTP2_ONLY) {\n        const existingClient = http2Sessions.free(connectionKey);\n\n        if (existingClient) {\n          return execHttp2(connectionKey, existingClient, req, url, config);\n        }\n      }\n\n      const socket = await netSockets.ready(connectionKey, (socket) => {\n        if (socket) return socket;\n\n        return netSockets.creating(connectionKey, async () => {\n          const socket = await createNetConnection({\n            host: hostname,\n            port,\n            lookup,\n          });\n          setupSocket(netSockets, connectionKey, socket, config);\n          return socket;\n        });\n      });\n\n      claimSocket(netSockets, connectionKey, socket, config);\n\n      // Use existing HTTP2 session in HTTP2-only mode.\n      if (negotiateHttpVersion === NegotiateHttpVersion.HTTP2_ONLY) {\n        const client = await http2Sessions.ready(\n          connectionKey,\n          (existingClient) => {\n            if (existingClient) {\n              freeSocket(netSockets, connectionKey, socket, config);\n              return existingClient;\n            }\n\n            return http2Sessions.creating(connectionKey, async () => {\n              const client = await createHttp2Connection(url, socket);\n              setupHttp2Client(connectionKey, client, config);\n              return client;\n            });\n          }\n        );\n\n        return execHttp2(connectionKey, client, req, url, config);\n      }\n\n      return execHttp1(req, url, socket, config);\n    }\n\n    // Optionally negotiate HTTP2 connection.\n    if (protocol === \"https:\") {\n      const {\n        ca,\n        cert,\n        key,\n        secureProtocol,\n        secureContext,\n        secureOptions,\n      } = options;\n      const port = Number(url.port) || 443;\n      const servername =\n        options.servername ||\n        calculateServerName(hostname, req.headers.get(\"host\"));\n      const rejectUnauthorized = options.rejectUnauthorized !== false;\n      const connectionKey = `${hostname}:${port}:${negotiateHttpVersion}:${servername}:${rejectUnauthorized}:${\n        ca || \"\"\n      }:${cert || \"\"}:${key || \"\"}:${secureProtocol || \"\"}`;\n\n      // Use an existing HTTP2 session before making a new attempt.\n      if (\n        negotiateHttpVersion === NegotiateHttpVersion.HTTP2_ONLY ||\n        negotiateHttpVersion === NegotiateHttpVersion.HTTP2_FOR_HTTPS\n      ) {\n        const existingSession = http2Sessions.free(connectionKey);\n\n        if (existingSession) {\n          return execHttp2(connectionKey, existingSession, req, url, config);\n        }\n      }\n\n      // Use an existing TLS session to speed up handshake.\n      const existingSocket = tlsSockets.get(connectionKey);\n      const session = existingSocket ? existingSocket.getSession() : undefined;\n      const ALPNProtocols =\n        negotiateHttpVersion === NegotiateHttpVersion.HTTP2_ONLY\n          ? [\"h2\"]\n          : negotiateHttpVersion === NegotiateHttpVersion.HTTP2_FOR_HTTPS\n          ? [\"h2\", \"http/1.1\"]\n          : undefined;\n\n      const socketOptions: TlsConnectOpts = {\n        host: hostname,\n        port,\n        servername,\n        rejectUnauthorized,\n        ca,\n        cert,\n        key,\n        session,\n        secureProtocol,\n        secureContext,\n        ALPNProtocols,\n        lookup,\n        secureOptions,\n      };\n\n      const socket = await tlsSockets.ready(connectionKey, (socket) => {\n        if (socket) return socket;\n\n        return tlsSockets.creating(connectionKey, async () => {\n          const socket = await createTlsConnection(socketOptions);\n          setupSocket(tlsSockets, connectionKey, socket, config);\n          return socket;\n        });\n      });\n\n      claimSocket(tlsSockets, connectionKey, socket, config);\n\n      if (negotiateHttpVersion === NegotiateHttpVersion.HTTP1_ONLY) {\n        return execHttp1(req, url, socket, config);\n      }\n\n      if (negotiateHttpVersion === NegotiateHttpVersion.HTTP2_ONLY) {\n        const client = await http2Sessions.ready(\n          connectionKey,\n          (existingClient) => {\n            if (existingClient) {\n              freeSocket(tlsSockets, connectionKey, socket, config);\n              return existingClient;\n            }\n\n            return http2Sessions.creating(connectionKey, async () => {\n              const client = await createHttp2Connection(url, socket);\n              setupHttp2Client(connectionKey, client, config);\n              return client;\n            });\n          }\n        );\n\n        return execHttp2(connectionKey, client, req, url, config);\n      }\n\n      return new Promise<HttpResponse | Http2Response>((resolve, reject) => {\n        const onClose = () => {\n          socket.removeListener(\"error\", onError);\n          socket.removeListener(\"connect\", onConnect);\n\n          return reject(new ALPNError(req, \"TLS connection closed early\"));\n        };\n\n        const onError = (err: Error) => {\n          socket.removeListener(\"connect\", onConnect);\n          socket.removeListener(\"close\", onClose);\n\n          return reject(\n            new ConnectionError(\n              req,\n              `Unable to connect to ${hostname}:${port}`,\n              err\n            )\n          );\n        };\n\n        // Execute HTTP connection according to negotiated ALPN protocol.\n        const onConnect = () => {\n          socket.removeListener(\"error\", onError);\n          socket.removeListener(\"close\", onClose);\n\n          // Workaround for https://github.com/nodejs/node/pull/32958/files#r418695485.\n          (socket as any).secureConnecting = false;\n\n          // Successfully negotiated HTTP2 connection.\n          if (socket.alpnProtocol === \"h2\") {\n            return resolve(\n              http2Sessions\n                .ready(connectionKey, (existingClient) => {\n                  if (existingClient) {\n                    freeSocket(tlsSockets, connectionKey, socket, config);\n                    return existingClient;\n                  }\n\n                  return http2Sessions.creating(connectionKey, async () => {\n                    const client = await createHttp2Connection(url, socket);\n                    setupHttp2Client(connectionKey, client, config);\n                    return client;\n                  });\n                })\n                .then((client) =>\n                  execHttp2(connectionKey, client, req, url, config)\n                )\n            );\n          }\n\n          if (socket.alpnProtocol === \"http/1.1\" || !socket.alpnProtocol) {\n            return resolve(execHttp1(req, url, socket, config));\n          }\n\n          return reject(\n            new ALPNError(\n              req,\n              `Unknown ALPN protocol negotiated: ${socket.alpnProtocol}`\n            )\n          );\n        };\n\n        // Existing socket may already have negotiated ALPN protocol.\n        // Can be `null`, a string, or `false` when no protocol negotiated.\n        if (socket.alpnProtocol != null) return onConnect();\n\n        socket.once(\"secureConnect\", onConnect);\n        socket.once(\"error\", onError);\n        socket.once(\"close\", onClose);\n      });\n    }\n\n    return next();\n  };\n}\n\n/**\n * Set socket config for usage, and configure for issues between assigning a socket and making the request.\n */\nfunction claimSocket<T extends Socket | TLSSocket>(\n  manager: ConnectionManager<T>,\n  key: string,\n  socket: T,\n  config: TransportConfig\n) {\n  socket.setTimeout(config.idleSocketTimeout);\n  manager.used(key, socket);\n}\n\n/**\n * Free a socket in the manager.\n */\nfunction freeSocket<T extends Socket | TLSSocket>(\n  manager: ConnectionManager<T>,\n  key: string,\n  socket: T,\n  config: TransportConfig\n) {\n  socket.setTimeout(config.idleSocketTimeout);\n\n  const shouldDestroy = manager.freed(key, socket);\n  if (shouldDestroy) socket.destroy();\n}\n\n/**\n * Setup the socket with the connection manager.\n *\n * Ref: https://github.com/nodejs/node/blob/531b4bedcac14044f09129ffb65dab71cc2707d9/lib/_http_agent.js#L254\n */\nfunction setupSocket<T extends Socket | TLSSocket>(\n  manager: ConnectionManager<T>,\n  key: string,\n  socket: T,\n  config: TransportConfig\n) {\n  const onFree = () => freeSocket(manager, key, socket, config);\n\n  const cleanup = () => {\n    manager.delete(key, socket);\n    socket.removeListener(\"free\", onFree);\n    socket.removeListener(\"close\", cleanup);\n    socket.removeListener(\"error\", cleanup);\n    socket.removeListener(\"timeout\", onTimeout);\n  };\n\n  const onTimeout = () => {\n    socket.destroy();\n    return cleanup();\n  };\n\n  socket.on(\"free\", onFree);\n  socket.once(\"close\", cleanup);\n  socket.once(\"error\", cleanup);\n  socket.once(\"timeout\", onTimeout);\n\n  if (config.keepAlive > 0) socket.setKeepAlive(true, config.keepAlive);\n}\n\n/**\n * Set up a HTTP2 working session.\n */\nfunction setupHttp2Client(\n  key: string,\n  client: ClientHttp2Session,\n  config: TransportConfig\n) {\n  const cleanup = () => {\n    client.removeListener(\"error\", cleanup);\n    client.removeListener(\"goaway\", cleanup);\n    client.removeListener(\"close\", cleanup);\n    config.http2Sessions.delete(key, client);\n  };\n\n  client.once(\"error\", cleanup);\n  client.once(\"goaway\", cleanup);\n  client.once(\"close\", cleanup);\n}\n\n/**\n * Ref: https://github.com/nodejs/node/blob/5823938d156f4eb6dc718746afbf58f1150f70fb/lib/_http_agent.js#L231\n */\nfunction calculateServerName(hostname: string, hostHeader: string | null) {\n  if (!hostHeader) return hostname;\n  if (hostHeader.charAt(0) === \"[\") {\n    const index = hostHeader.indexOf(\"]\");\n    if (index === -1) return hostHeader;\n    return hostHeader.substr(1, index - 1);\n  }\n  return hostHeader.split(\":\", 1)[0];\n}\n"]}